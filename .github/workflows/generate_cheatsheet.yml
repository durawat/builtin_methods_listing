name: Generate cheatsheet

on:
  workflow_run:
    workflows: ["pytest"]
    types: [completed]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Generate and commit cheatsheet
        run: |
          mkdir -p docs
          python -m myproj.cli cheatsheet -o docs/builtins_cheatsheet -f markdown

          if [ -f docs/builtins_cheatsheet.md ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add docs/builtins_cheatsheet.md
            git commit -m "chore: update generated builtins cheatsheet" || echo "no changes to commit"
            git push
          else
            echo "Success: cheatsheet generation completed"
          fi
